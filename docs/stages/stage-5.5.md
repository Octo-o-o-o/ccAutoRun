# Stage 5.5: æµ‹è¯•åŸºç¡€è®¾æ–½å’Œæµ‹è¯•è¦†ç›– ğŸ§ª

**[â† è¿”å›ä¸»è®¡åˆ’](../../EXECUTION_PLAN.md)** | **[â† Stage 5](stage-5.md)** | **[Stage 7 â†’](stage-7.md)**

---

## ğŸ“‹ é˜¶æ®µä¿¡æ¯

- **é˜¶æ®µç¼–å·**: Stage 5.5
- **é¢„è®¡æ—¶é—´**: 6-8å°æ—¶
- **ä¾èµ–**: Stage 5
- **çŠ¶æ€**: â³ å¾…å¼€å§‹

### ğŸ¯ ç›®æ ‡
å»ºç«‹å®Œæ•´çš„æµ‹è¯•åŸºç¡€è®¾æ–½ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½çš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼Œè¦†ç›–ç‡è¾¾åˆ° 70%+

### ğŸ“ ä»»åŠ¡æ¸…å•
- [ ] é…ç½® Vitest æµ‹è¯•æ¡†æ¶
  - åˆ›å»º `vitest.config.js`
  - é…ç½® ES Modules æ”¯æŒ
  - é…ç½®è¦†ç›–ç‡æŠ¥å‘Šï¼ˆc8 æˆ– v8ï¼‰
  - è®¾ç½®æµ‹è¯•ç¯å¢ƒï¼ˆNode.jsï¼‰
  - é…ç½®æµ‹è¯•è¶…æ—¶å’Œé‡è¯•
  - æ·»åŠ  npm scriptsï¼š
    - `npm test` - è¿è¡Œæ‰€æœ‰æµ‹è¯•
    - `npm run test:watch` - watch æ¨¡å¼
    - `npm run test:coverage` - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    - `npm run test:ui` - å¯åŠ¨æµ‹è¯• UI

- [ ] å•å…ƒæµ‹è¯• - æ ¸å¿ƒæ¨¡å—ï¼ˆ`tests/unit/`ï¼‰
  - [ ] `tests/unit/plan-parser.test.js`ï¼ˆå…³é”®ï¼ï¼‰
    - æµ‹è¯•æ‹†åˆ†æ¶æ„è§£æï¼ˆREADME.md + stages/ï¼‰
    - æµ‹è¯•å•æ–‡ä»¶æ¶æ„è§£æï¼ˆtask-name.mdï¼‰
    - æµ‹è¯•é…ç½®å¤´è§£æï¼ˆAUTO-RUN-CONFIGï¼‰
    - æµ‹è¯• Stage æ–‡ä»¶è¯»å–å’Œé¡ºåº
    - æµ‹è¯•é”™è¯¯å¤„ç†ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ã€æ ¼å¼é”™è¯¯ç­‰ï¼‰
    - æµ‹è¯•æ¶æ„ç±»å‹æ£€æµ‹
    - è‡³å°‘ 15 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - [ ] `tests/unit/session-manager.test.js`
    - æµ‹è¯•ä¼šè¯åˆ›å»ºå’Œåˆå§‹åŒ–
    - æµ‹è¯•ä¼šè¯çŠ¶æ€æ›´æ–°ï¼ˆactive/paused/failed/completedï¼‰
    - æµ‹è¯•åŸå­å†™å…¥æœºåˆ¶ï¼ˆtmp + renameï¼‰
    - æµ‹è¯• failed çŠ¶æ€å’Œ lastError è®°å½•
    - æµ‹è¯•ä¼šè¯æŸ¥è¯¢å’Œåˆ—è¡¨
    - æµ‹è¯•å¹¶å‘å†™å…¥å®‰å…¨æ€§
    - è‡³å°‘ 12 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - [ ] `tests/unit/safety-limiter.test.js`
    - æµ‹è¯•å®‰å…¨é™åˆ¶æ£€æŸ¥
    - æµ‹è¯• unlimited æ¨¡å¼
    - æµ‹è¯•æ•°å­—é™åˆ¶æ¨¡å¼
    - æµ‹è¯•é™åˆ¶è¾¾åˆ°æ—¶çš„è¡Œä¸º
    - æµ‹è¯•é™åˆ¶é‡ç½®
    - è‡³å°‘ 8 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - [ ] `tests/unit/config-validator.test.js`
    - æµ‹è¯•é…ç½®æ ¼å¼éªŒè¯
    - æµ‹è¯•å¿…å¡«å­—æ®µæ£€æŸ¥
    - æµ‹è¯•æ•°æ®ç±»å‹éªŒè¯
    - æµ‹è¯•é»˜è®¤å€¼åº”ç”¨
    - æµ‹è¯•ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
    - è‡³å°‘ 10 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - [ ] `tests/unit/notifier.test.js`
    - æµ‹è¯•é€šçŸ¥æ¥å£ï¼ˆprogress/error/complete/warningï¼‰
    - æµ‹è¯•è·¨å¹³å°å…¼å®¹æ€§ï¼ˆmock node-notifierï¼‰
    - æµ‹è¯•é”™è¯¯å¤„ç†ï¼ˆé€šçŸ¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰
    - è‡³å°‘ 6 ä¸ªæµ‹è¯•ç”¨ä¾‹

- [ ] é›†æˆæµ‹è¯• - CLI å‘½ä»¤ï¼ˆ`tests/integration/`ï¼‰
  - [ ] `tests/integration/commands/init.test.js`
    - æµ‹è¯•é¡¹ç›®åˆå§‹åŒ–
    - æµ‹è¯•ç›®å½•ç»“æ„åˆ›å»º
    - æµ‹è¯•é…ç½®æ–‡ä»¶ç”Ÿæˆ
    - æµ‹è¯• hook è‡ªåŠ¨é…ç½®ï¼ˆ--setup-hooksï¼‰
    - æµ‹è¯•å·²å­˜åœ¨é¡¹ç›®çš„å¤„ç†
    - è‡³å°‘ 8 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - [ ] `tests/integration/commands/list-status.test.js`
    - æµ‹è¯• list å‘½ä»¤ï¼ˆä¸¤ç§æ¶æ„ï¼‰
    - æµ‹è¯• status å‘½ä»¤ï¼ˆä¸¤ç§æ¶æ„ï¼‰
    - æµ‹è¯•ç©ºä»»åŠ¡åˆ—è¡¨
    - æµ‹è¯•è¿›åº¦æ˜¾ç¤º
    - æµ‹è¯•æ¶æ„ç±»å‹æ ‡è¯†ï¼ˆğŸ“/ğŸ“„ï¼‰
    - è‡³å°‘ 10 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - [ ] `tests/integration/commands/control.test.js`
    - æµ‹è¯• pause/resume å‘½ä»¤
    - æµ‹è¯• skip å‘½ä»¤
    - æµ‹è¯• retry å‘½ä»¤
    - æµ‹è¯• recover å‘½ä»¤
    - æµ‹è¯•çŠ¶æ€è½¬æ¢
    - è‡³å°‘ 10 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - [ ] `tests/integration/commands/config.test.js`
    - æµ‹è¯• config äº¤äº’å¼é…ç½®
    - æµ‹è¯• --get/--set/--list
    - æµ‹è¯•é…ç½®æŒä¹…åŒ–
    - æµ‹è¯•é…ç½®éªŒè¯
    - è‡³å°‘ 8 ä¸ªæµ‹è¯•ç”¨ä¾‹

- [ ] Hook æµ‹è¯•ï¼ˆ`tests/hooks/`ï¼‰
  - [ ] `tests/hooks/auto-continue.test.js`ï¼ˆå…³é”®ï¼ï¼‰
    - æµ‹è¯• Hook è§¦å‘æœºåˆ¶
    - æµ‹è¯•ä¸‰å±‚é™çº§ç­–ç•¥ï¼š
      - ä¸»ç­–ç•¥ï¼štranscript æ ‡è®°æ£€æµ‹
      - é™çº§1ï¼šç‹¬ç«‹æ ‡è®°æ–‡ä»¶
      - é™çº§2ï¼šæ–‡ä»¶ä¿®æ”¹æ—¶é—´
      - æœ€ç»ˆé™çº§ï¼šç”¨æˆ·é€šçŸ¥
    - æµ‹è¯•é”™è¯¯æ£€æµ‹å’Œ failed çŠ¶æ€
    - æµ‹è¯•å®‰å…¨é™åˆ¶é›†æˆ
    - æµ‹è¯•é€šçŸ¥é›†æˆ
    - æµ‹è¯• --dangerously-skip-permissions æ¨¡å¼
    - Mock Claude Code transcript æ–‡ä»¶
    - è‡³å°‘ 15 ä¸ªæµ‹è¯•ç”¨ä¾‹

- [ ] E2E æµ‹è¯•ï¼ˆ`tests/e2e/`ï¼‰
  - [ ] `tests/e2e/full-workflow.test.js`
    - æµ‹è¯•å®Œæ•´å·¥ä½œæµï¼š
      1. init åˆå§‹åŒ–é¡¹ç›®
      2. æ¨¡æ‹Ÿ /plan ç”Ÿæˆè®¡åˆ’ï¼ˆæ‹†åˆ†æ¶æ„ï¼‰
      3. æ¨¡æ‹Ÿæ‰§è¡Œç¬¬ä¸€ä¸ª Stage
      4. Hook è‡ªåŠ¨ç»§ç»­
      5. å®Œæˆæ‰€æœ‰ Stage
      6. éªŒè¯æœ€ç»ˆçŠ¶æ€
    - ä½¿ç”¨ä¸´æ—¶ç›®å½•éš”ç¦»æµ‹è¯•
    - è‡³å°‘ 3 ä¸ªå®Œæ•´æµç¨‹æµ‹è¯•ç”¨ä¾‹

- [ ] æµ‹è¯•å·¥å…·å’Œ Mockï¼ˆ`tests/helpers/`ï¼‰
  - [ ] `tests/helpers/fixtures.js`
    - åˆ›å»ºæµ‹è¯•ç”¨çš„è®¡åˆ’æ–‡æ¡£ fixtures
    - æ‹†åˆ†æ¶æ„ fixtureï¼ˆREADME + stagesï¼‰
    - å•æ–‡ä»¶æ¶æ„ fixture
    - å„ç§é…ç½®æ–‡ä»¶ fixtures
  - [ ] `tests/helpers/mock-fs.js`
    - Mock æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
    - æä¾›ä¸´æ—¶ç›®å½•ç®¡ç†
  - [ ] `tests/helpers/mock-claude.js`
    - Mock Claude Code transcript
    - Mock Hook è§¦å‘ç¯å¢ƒ
  - [ ] `tests/helpers/test-utils.js`
    - é€šç”¨æµ‹è¯•å·¥å…·å‡½æ•°
    - æ–­è¨€è¾…åŠ©å‡½æ•°

### âœ… å®Œæˆæ ‡å‡†
- [ ] Vitest é…ç½®å®Œæˆä¸”å¯ä»¥è¿è¡Œæµ‹è¯•
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆè‡³å°‘ 51 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆè‡³å°‘ 36 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] Hook æµ‹è¯•é€šè¿‡ï¼ˆè‡³å°‘ 15 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] E2E æµ‹è¯•é€šè¿‡ï¼ˆè‡³å°‘ 3 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [ ] æ€»æµ‹è¯•ç”¨ä¾‹æ•°ï¼š**105+**
- [ ] **æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ° 70%+**ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰
- [ ] è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆæ­£å¸¸
- [ ] æ‰€æœ‰æµ‹è¯•åœ¨ CI ç¯å¢ƒå¯è¿è¡Œï¼ˆå‡†å¤‡ GitHub Actionsï¼‰
- [ ] æµ‹è¯•è¿è¡Œæ—¶é—´ < 30 ç§’ï¼ˆä¸å« E2Eï¼‰
- [ ] æ²¡æœ‰ flaky testsï¼ˆä¸ç¨³å®šçš„æµ‹è¯•ï¼‰

### ğŸ“¤ é¢„æœŸè¾“å‡º
- [ ] `vitest.config.js` (50è¡Œ)
- [ ] `tests/unit/plan-parser.test.js` (400è¡Œ)
- [ ] `tests/unit/session-manager.test.js` (350è¡Œ)
- [ ] `tests/unit/safety-limiter.test.js` (250è¡Œ)
- [ ] `tests/unit/config-validator.test.js` (300è¡Œ)
- [ ] `tests/unit/notifier.test.js` (200è¡Œ)
- [ ] `tests/integration/commands/init.test.js` (280è¡Œ)
- [ ] `tests/integration/commands/list-status.test.js` (350è¡Œ)
- [ ] `tests/integration/commands/control.test.js` (350è¡Œ)
- [ ] `tests/integration/commands/config.test.js` (280è¡Œ)
- [ ] `tests/hooks/auto-continue.test.js` (500è¡Œ)
- [ ] `tests/e2e/full-workflow.test.js` (400è¡Œ)
- [ ] `tests/helpers/fixtures.js` (200è¡Œ)
- [ ] `tests/helpers/mock-fs.js` (150è¡Œ)
- [ ] `tests/helpers/mock-claude.js` (180è¡Œ)
- [ ] `tests/helpers/test-utils.js` (120è¡Œ)
- [ ] **æ€»è®¡ï¼š~3,800 è¡Œæµ‹è¯•ä»£ç **

### âš ï¸ æ³¨æ„äº‹é¡¹
- **æµ‹è¯•ä¼˜å…ˆçº§**ï¼š
  - P0ï¼ˆå¿…é¡»ï¼‰ï¼šplan-parser, session-manager, auto-continue hook
  - P1ï¼ˆé‡è¦ï¼‰ï¼šsafety-limiter, config-validator, æ ¸å¿ƒå‘½ä»¤
  - P2ï¼ˆå¯é€‰ï¼‰ï¼šnotifier, è¾…åŠ©å‘½ä»¤
- **Hook æµ‹è¯•éš¾ç‚¹**ï¼š
  - éœ€è¦ Mock Claude Code çš„ transcript æ–‡ä»¶
  - éœ€è¦æ¨¡æ‹Ÿæ–‡ä»¶ä¿®æ”¹æ—¶é—´
  - éœ€è¦æµ‹è¯•å¼‚æ­¥è¡Œä¸ºå’Œå®šæ—¶å™¨
  - å»ºè®®ä½¿ç”¨ `vi.useFakeTimers()` æ§åˆ¶æ—¶é—´
- **E2E æµ‹è¯•éš”ç¦»**ï¼š
  - æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„ä¸´æ—¶ç›®å½•
  - æµ‹è¯•åæ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
  - ä½¿ç”¨ `afterEach` ç¡®ä¿æ¸…ç†
- **è¦†ç›–ç‡ç›®æ ‡**ï¼š
  - æ ¸å¿ƒæ¨¡å—ï¼ˆparser, session, hookï¼‰ï¼š80%+
  - CLI å‘½ä»¤ï¼š60%+
  - å·¥å…·å‡½æ•°ï¼š70%+
  - æ€»ä½“ï¼š70%+
- **CI å‡†å¤‡**ï¼š
  - ç¡®ä¿æµ‹è¯•ä¸ä¾èµ–æœ¬åœ°ç¯å¢ƒ
  - ç¡®ä¿æµ‹è¯•å¯ä»¥å¹¶è¡Œè¿è¡Œ
  - å‡†å¤‡ `.github/workflows/test.yml`ï¼ˆåœ¨ Stage 6ï¼‰
- **æµ‹è¯•æ•°æ®**ï¼š
  - ä½¿ç”¨ fixtures ç›®å½•å­˜å‚¨æµ‹è¯•æ•°æ®
  - ä¸è¦åœ¨æµ‹è¯•ä¸­ç¡¬ç¼–ç é•¿å­—ç¬¦ä¸²
  - ä½¿ç”¨ `__dirname` æˆ– `import.meta.url` å®šä½æµ‹è¯•èµ„æº
- **Mock ç­–ç•¥**ï¼š
  - æ–‡ä»¶ç³»ç»Ÿï¼šä½¿ç”¨çœŸå®çš„ä¸´æ—¶ç›®å½•ï¼ˆä¸ç”¨ mock-fs åº“ï¼Œå…¼å®¹æ€§å·®ï¼‰
  - å¤–éƒ¨ä¾èµ–ï¼ˆnode-notifierï¼‰ï¼šä½¿ç”¨ vi.mock()
  - Claude Code transcriptï¼šä½¿ç”¨è‡ªå®šä¹‰ Mock
- **æµ‹è¯•å‘½åè§„èŒƒ**ï¼š
  - å•å…ƒæµ‹è¯•ï¼š`should [expected behavior] when [condition]`
  - é›†æˆæµ‹è¯•ï¼š`command should [expected behavior]`
  - E2E æµ‹è¯•ï¼š`full workflow: [scenario description]`

### ğŸ§ª éªŒè¯å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test
# åº”æ˜¾ç¤º 105+ ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¦†ç›–ç‡
npm run test:coverage
# åº”æ˜¾ç¤ºè¦†ç›–ç‡ 70%+

# è¿è¡Œå•å…ƒæµ‹è¯•
npm test tests/unit
# åº”é€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•ï¼ˆ51+ ä¸ªï¼‰

# è¿è¡Œé›†æˆæµ‹è¯•
npm test tests/integration
# åº”é€šè¿‡æ‰€æœ‰é›†æˆæµ‹è¯•ï¼ˆ36+ ä¸ªï¼‰

# è¿è¡Œ Hook æµ‹è¯•
npm test tests/hooks
# åº”é€šè¿‡æ‰€æœ‰ Hook æµ‹è¯•ï¼ˆ15+ ä¸ªï¼‰

# è¿è¡Œ E2E æµ‹è¯•
npm test tests/e2e
# åº”é€šè¿‡æ‰€æœ‰ E2E æµ‹è¯•ï¼ˆ3+ ä¸ªï¼‰

# Watch æ¨¡å¼ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
npm run test:watch

# æµ‹è¯• UIï¼ˆå¯è§†åŒ–ï¼‰
npm run test:ui
# åº”åœ¨æµè§ˆå™¨æ‰“å¼€æµ‹è¯•ç•Œé¢

# æµ‹è¯•ç‰¹å®šæ–‡ä»¶
npm test tests/unit/plan-parser.test.js

# æµ‹è¯•ç‰¹å®šç”¨ä¾‹ï¼ˆä½¿ç”¨ -t å‚æ•°ï¼‰
npm test -t "should parse split architecture"

# æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š
open coverage/index.html
# åº”æ˜¾ç¤ºè¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Š
```

---


# Stage 6: é›†æˆæµ‹è¯•ã€å…¼å®¹æ€§éªŒè¯å’Œé”™è¯¯æ¢å¤ ğŸ§ª

**[â† è¿”å›ä¸»è®¡åˆ’](../../EXECUTION_PLAN.md)** | **[â† Stage 5.5](stage-5.5.md)** | **ä¸‹ä¸€é˜¶æ®µ: [Stage 7 â†’](stage-7.md)**

---

## ğŸ“‹ é˜¶æ®µä¿¡æ¯

- **é˜¶æ®µç¼–å·**: Stage 6
- **é¢„è®¡æ—¶é—´**: 6-8å°æ—¶
- **ä¾èµ–**: Stage 1-5.5ï¼ˆæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å’Œå•å…ƒæµ‹è¯•å®Œæˆï¼‰
- **çŠ¶æ€**: â³ å¾…å¼€å§‹

### ğŸ¯ ç›®æ ‡
å®ç°ç«¯åˆ°ç«¯æµ‹è¯•ã€è·¨å¹³å°å…¼å®¹æ€§éªŒè¯ã€é”™è¯¯æ¢å¤ç³»ç»Ÿã€æ€§èƒ½æµ‹è¯•å’Œå®‰å…¨å®¡è®¡

### ğŸ“ ä»»åŠ¡æ¸…å•

#### 6.1 ç«¯åˆ°ç«¯ï¼ˆE2Eï¼‰æµ‹è¯•
- [ ] åˆ›å»º E2E æµ‹è¯•æ¡†æ¶é…ç½®
  - `tests/e2e/` ç›®å½•ç»“æ„
  - E2E æµ‹è¯•å·¥å…·é“¾ï¼ˆvitest + çœŸå®æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼‰
- [ ] ç¼–å†™æ ¸å¿ƒåœºæ™¯ E2E æµ‹è¯•
  - **åœºæ™¯1**: ä»é›¶å¼€å§‹åˆ›å»ºè®¡åˆ’å¹¶æ‰§è¡Œ
    ```bash
    ccautorun init â†’ ç”Ÿæˆè®¡åˆ’ â†’ æ‰§è¡Œ â†’ å®Œæˆ
    ```
  - **åœºæ™¯2**: å¤šè®¡åˆ’å¹¶è¡Œç®¡ç†
    ```bash
    åˆ›å»ºè®¡åˆ’A â†’ åˆ›å»ºè®¡åˆ’B â†’ æ£€æŸ¥å¹¶å‘å†²çª â†’ list/status
    ```
  - **åœºæ™¯3**: è®¡åˆ’ä¸­æ–­å’Œæ¢å¤
    ```bash
    æ‰§è¡Œåˆ°Stage 3 â†’ äººå·¥ä¸­æ–­ â†’ ccautorun recover â†’ ç»§ç»­æ‰§è¡Œ
    ```
  - **åœºæ™¯4**: Archive å’Œæ¸…ç†
    ```bash
    å®Œæˆè®¡åˆ’ â†’ archive â†’ éªŒè¯å¤‡ä»½ â†’ æ¸…ç†
    ```

#### 6.2 è·¨å¹³å°å…¼å®¹æ€§æµ‹è¯•
- [ ] macOS æµ‹è¯•å¥—ä»¶
  - Intel å’Œ Apple Silicon æ¶æ„æµ‹è¯•
  - æ–‡ä»¶è·¯å¾„å¤„ç†ï¼ˆHFS+/APFSï¼‰
  - é€šçŸ¥ç³»ç»Ÿï¼ˆmacOS Notification Centerï¼‰
- [ ] Windows æµ‹è¯•å¥—ä»¶
  - PowerShell å’Œ cmd.exe ç¯å¢ƒ
  - æ–‡ä»¶è·¯å¾„å¤„ç†ï¼ˆWindowsè·¯å¾„ã€å¤§å°å†™ä¸æ•æ„Ÿï¼‰
  - é€šçŸ¥ç³»ç»Ÿï¼ˆWindows 10/11 Toastï¼‰
  - æƒé™å¤„ç†ï¼ˆUACè€ƒè™‘ï¼‰
- [ ] Linux æµ‹è¯•å¥—ä»¶
  - Ubuntu 20.04+, Debian 11+, CentOS 8+
  - æ–‡ä»¶æƒé™å’Œå¯æ‰§è¡Œä½
  - é€šçŸ¥ç³»ç»Ÿï¼ˆlibnotifyï¼‰
- [ ] ç¼–å†™è·¨å¹³å°æµ‹è¯•è¾…åŠ©å·¥å…·
  ```javascript
  // tests/helpers/platform-test.js
  export function runOnPlatform(platform, testFn) { ... }
  export function mockPlatformAPIs() { ... }
  ```

#### 6.3 é”™è¯¯æ¢å¤ç³»ç»Ÿå®ç°
- [ ] å®ç° `src/core/recovery-manager.js`
  ```javascript
  export class RecoveryManager {
    detectFailure(sessionId)      // æ£€æµ‹ Stage å¤±è´¥
    createSnapshot(sessionId)     // åˆ›å»ºå¿«ç…§
    listRecoveryPoints(planId)    // åˆ—å‡ºå¯æ¢å¤ç‚¹
    recover(planId, strategy)     // æ‰§è¡Œæ¢å¤
  }
  ```
- [ ] å®ç° `src/core/snapshot-manager.js`
  ```javascript
  export class SnapshotManager {
    createSnapshot(planId, stage)  // åˆ›å»ºå¿«ç…§
    restoreSnapshot(snapshotId)    // æ¢å¤å¿«ç…§
    listSnapshots(planId)          // åˆ—å‡ºå¿«ç…§
    cleanupSnapshots(retention)    // æ¸…ç†æ—§å¿«ç…§
  }
  ```
- [ ] å®ç° `src/commands/recover.js`
  ```bash
  ccautorun recover [plan-id]
    --strategy retry|skip|rollback|abort
    --stage <stage-number>
  ```
- [ ] å®ç°å†²çªæ£€æµ‹æœºåˆ¶
  - æ£€æµ‹å¤šä¸ªè®¡åˆ’åŒæ—¶ä¿®æ”¹åŒä¸€æ–‡ä»¶
  - æä¾›å†²çªè§£å†³é€‰é¡¹
  - æ–‡ä»¶é”æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
- [ ] Hook é›†æˆé”™è¯¯æ£€æµ‹
  - ä¿®æ”¹ auto-continue hook æ·»åŠ å¤±è´¥æ£€æµ‹
  - è‡ªåŠ¨è§¦å‘ recovery æç¤º

#### 6.4 æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] åˆ›å»ºæ€§èƒ½æµ‹è¯•å¥—ä»¶ `tests/performance/`
- [ ] ç¼–å†™æ€§èƒ½æµ‹è¯•ç”¨ä¾‹
  - **å°é¡¹ç›®**ï¼ˆ< 1000è¡Œï¼‰ï¼šè®¡åˆ’ç”Ÿæˆ < 10ç§’
  - **ä¸­å‹é¡¹ç›®**ï¼ˆ1000-10000è¡Œï¼‰ï¼šè®¡åˆ’ç”Ÿæˆ < 30ç§’
  - **å¤§å‹é¡¹ç›®**ï¼ˆ10000-50000è¡Œï¼‰ï¼šè®¡åˆ’ç”Ÿæˆ < 60ç§’
  - Hook å“åº”æ—¶é—´ï¼š< 2ç§’
  - å†…å­˜å ç”¨ï¼š< 200MBï¼ˆå¸¸é©»ï¼‰
- [ ] æ€§èƒ½ç›‘æ§å·¥å…·
  ```bash
  ccautorun doctor --performance
  # æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡ã€ç“¶é¢ˆåˆ†æ
  ```
- [ ] ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
  - åŸºå‡†æµ‹è¯•ç»“æœæ–‡æ¡£
  - æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 6.5 å®‰å…¨å®¡è®¡
- [ ] ä¾èµ–å®‰å…¨æ‰«æ
  ```bash
  npm audit
  npm audit fix
  ```
- [ ] ä»£ç å®‰å…¨å®¡è®¡
  - æ£€æŸ¥æ–‡ä»¶æ“ä½œæƒé™
  - æ£€æŸ¥ shell å‘½ä»¤æ³¨å…¥é£é™©
  - æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼ˆAPI keysã€tokensï¼‰
- [ ] æƒé™æœ€å°åŒ–åŸåˆ™
  - éªŒè¯ `--dangerously-skip-permissions` ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨
  - æ–‡ä»¶æ“ä½œé™åˆ¶åœ¨ `.ccautorun/` ç›®å½•
- [ ] åˆ›å»º `SECURITY.md` å®‰å…¨ç­–ç•¥æ–‡æ¡£

#### 6.6 æµ‹è¯•æ–‡æ¡£å’ŒCIé›†æˆ
- [ ] ç¼–å†™æµ‹è¯•æ–‡æ¡£
  - `docs/TESTING.md`ï¼šæµ‹è¯•æŒ‡å—
  - æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šè¯´æ˜
  - å¦‚ä½•è¿è¡Œä¸åŒç±»å‹çš„æµ‹è¯•
- [ ] å‡†å¤‡ GitHub Actions é…ç½®ï¼ˆStage 7ä¼šå®Œå–„ï¼‰
  ```yaml
  # .github/workflows/test.yml
  - name: Run E2E tests
  - name: Run cross-platform tests
  - name: Security audit
  ```

### âœ… å®Œæˆæ ‡å‡†
- [ ] E2E æµ‹è¯•è¦†ç›–è‡³å°‘ 4 ä¸ªæ ¸å¿ƒåœºæ™¯
- [ ] åœ¨è‡³å°‘ 2 ä¸ªå¹³å°ä¸Šæµ‹è¯•é€šè¿‡ï¼ˆmacOS + Windows/Linuxï¼‰
- [ ] é”™è¯¯æ¢å¤ç³»ç»ŸåŠŸèƒ½å®Œæ•´ä¸”æœ‰æµ‹è¯•è¦†ç›–
- [ ] æ€§èƒ½æµ‹è¯•è¾¾åˆ°æ‰€æœ‰åŸºå‡†ç›®æ ‡
- [ ] npm audit æ— é«˜å±æ¼æ´
- [ ] ä»£ç å®‰å…¨å®¡è®¡é€šè¿‡ï¼ˆæ— æ³¨å…¥æ¼æ´ï¼‰
- [ ] æµ‹è¯•è¦†ç›–ç‡ä¿æŒ > 80%

### ğŸ“¤ é¢„æœŸè¾“å‡º
- [ ] `tests/e2e/` - E2E æµ‹è¯•å¥—ä»¶
- [ ] `tests/performance/` - æ€§èƒ½æµ‹è¯•å¥—ä»¶
- [ ] `tests/helpers/platform-test.js` - è·¨å¹³å°æµ‹è¯•å·¥å…·
- [ ] `src/core/recovery-manager.js` - æ¢å¤ç®¡ç†å™¨
- [ ] `src/core/snapshot-manager.js` - å¿«ç…§ç®¡ç†å™¨
- [ ] `src/commands/recover.js` - æ¢å¤å‘½ä»¤
- [ ] `.ccautorun/snapshots/` - å¿«ç…§å­˜å‚¨ç›®å½•
- [ ] `docs/TESTING.md` - æµ‹è¯•æ–‡æ¡£
- [ ] `SECURITY.md` - å®‰å…¨ç­–ç•¥æ–‡æ¡£
- [ ] æ€§èƒ½æµ‹è¯•æŠ¥å‘Šï¼ˆmarkdownæˆ–JSONï¼‰

### âš ï¸ æ³¨æ„äº‹é¡¹
- **å¿«ç…§å­˜å‚¨ç©ºé—´**: å¿«ç…§å¯èƒ½å ç”¨å¤§é‡ç©ºé—´ï¼Œéœ€è¦å®ç°è‡ªåŠ¨æ¸…ç†ç­–ç•¥ï¼ˆé»˜è®¤ä¿ç•™æœ€è¿‘5ä¸ªï¼‰
- **è·¨å¹³å°è·¯å¾„**: ä½¿ç”¨ `path` æ¨¡å—å¤„ç†æ‰€æœ‰è·¯å¾„ï¼Œé¿å…ç¡¬ç¼–ç åˆ†éš”ç¬¦
- **å¹¶å‘å®‰å…¨**: å¤šä¸ªè®¡åˆ’å¹¶å‘æ—¶ï¼Œç¡®ä¿æ–‡ä»¶æ“ä½œçš„åŸå­æ€§
- **æµ‹è¯•éš”ç¦»**: E2E æµ‹è¯•åº”åœ¨ä¸´æ—¶ç›®å½•è¿è¡Œï¼Œé¿å…æ±¡æŸ“çœŸå®ç¯å¢ƒ
- **æ€§èƒ½å›å½’**: å»ºç«‹æ€§èƒ½åŸºçº¿ï¼Œç›‘æ§åç»­å¼€å‘æ˜¯å¦å¼•å…¥æ€§èƒ½é€€åŒ–
- **æ•æ„Ÿä¿¡æ¯**: ä¸è¦åœ¨æµ‹è¯•ä¸­ç¡¬ç¼–ç çœŸå® API keys æˆ– tokens

### ğŸ§ª éªŒè¯å‘½ä»¤
```bash
# è¿è¡Œ E2E æµ‹è¯•
npm run test:e2e

# è¿è¡Œæ€§èƒ½æµ‹è¯•
npm run test:performance

# æµ‹è¯•é”™è¯¯æ¢å¤åŠŸèƒ½
ccautorun recover --help
# æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªå¤±è´¥åœºæ™¯ï¼Œæµ‹è¯•æ¢å¤

# å®‰å…¨å®¡è®¡
npm audit
npm run test:security  # å¦‚æœæœ‰è‡ªå®šä¹‰å®‰å…¨æµ‹è¯•

# è·¨å¹³å°æµ‹è¯•ï¼ˆéœ€è¦åœ¨ä¸åŒå¹³å°è¿è¡Œï¼‰
npm test -- --platform=mac
npm test -- --platform=windows
npm test -- --platform=linux

# å®Œæ•´æµ‹è¯•å¥—ä»¶
npm run test:all
```

### ğŸ”— ç›¸å…³æ–‡ä»¶
- **é”™è¯¯æ¢å¤**: `src/core/recovery-manager.js`, `src/core/snapshot-manager.js`
- **å¿«ç…§å­˜å‚¨**: `.ccautorun/snapshots/<plan-id>/<stage>/`
- **æµ‹è¯•å¥—ä»¶**: `tests/e2e/`, `tests/performance/`
- **Hook é›†æˆ**: `.claude/hooks/user-prompt-submit`

---

**å®Œæˆå**: æ›´æ–° [ä¸»è®¡åˆ’è¿›åº¦è¡¨](../../EXECUTION_PLAN.md#ğŸ“Š-è¿›åº¦è·Ÿè¸ª)ï¼Œgit commitï¼Œè¿›å…¥ Stage 7
